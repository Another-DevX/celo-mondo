import fs from 'fs';
import path from 'path';
import * as utils from 'src/features/delegation/utils';
import { getValidRequest } from 'src/test/delegatee-registration-utils';
import { expect, it, vi } from 'vitest';
import { POST } from './route';

const getRequest = (formData: FormData): Request => {
  return {
    formData: () => formData,
  } as any as Request;
};

const getValidFormData = async () => {
  const request = await getValidRequest();
  const data = new FormData();
  const imageBuffer = fs.readFileSync(
    path.join(__dirname, '../../../../../public/logos/validators/clabs.jpg'),
  );

  data.append('image', new Blob([imageBuffer], { type: 'image/jpeg' }), 'clabs.jpg');
  data.append('name', request.name);
  data.append('interests', request.interests);
  data.append('description', request.description);
  data.append('signature', request.signature as HexString);
  data.append('twitterUrl', request.twitterUrl as string);
  data.append('websiteUrl', request.websiteUrl as string);
  data.append('verificationUrl', request.verificationUrl as string);
  data.append('address', request.address);

  return data;
};

it('successfuly calls PR creation', async () => {
  const createDelegationPRMock = vi.spyOn(utils, 'createDelegationPR');
  const isAddressAnAccountMock = vi.spyOn(utils, 'isAddressAnAccount');

  createDelegationPRMock.mockResolvedValueOnce('http://example.com/pull-request');
  isAddressAnAccountMock.mockResolvedValueOnce(true);

  const response = await POST(getRequest(await getValidFormData()));

  expect(response.status).toBe(200);

  const body = await response.json();

  expect(body).toMatchInlineSnapshot(`
    {
      "pullRequestUrl": "http://example.com/pull-request",
      "status": "success",
    }
  `);
  expect(isAddressAnAccountMock).toHaveBeenCalledTimes(1);
  expect(createDelegationPRMock).toHaveBeenCalledTimes(1);
  expect(createDelegationPRMock.mock.lastCall).toMatchInlineSnapshot(`
    [
      {
        "address": "0x6A5DD51Da29914e8659b9CC354B414f30c7692c4",
        "description": "Delegatee description",
        "image": File {
          "lastModified": 1734515611255,
          "name": "blob",
          "type": "image/jpeg",
          Symbol(buffer): {
            "data": [
              255,
              216,
              255,
              224,
              0,
              16,
              74,
              70,
              73,
              70,
              0,
              1,
              1,
              0,
              0,
              1,
              0,
              1,
              0,
              0,
              255,
              219,
              0,
              132,
              0,
              8,
              8,
              8,
              8,
              9,
              8,
              9,
              10,
              10,
              9,
              13,
              14,
              12,
              14,
              13,
              19,
              17,
              16,
              16,
              17,
              19,
              28,
              20,
              22,
              20,
              22,
              20,
              28,
              43,
              27,
              31,
              27,
              27,
              31,
              27,
              43,
              38,
              46,
              37,
              35,
              37,
              46,
              38,
              68,
              53,
              47,
              47,
              53,
              68,
              78,
              66,
              62,
              66,
              78,
              95,
              85,
              85,
              95,
              119,
              113,
              119,
              156,
              156,
              209,
              1,
              8,
              8,
              8,
              8,
              9,
              8,
              9,
              10,
              10,
              9,
              13,
              14,
              12,
              14,
              13,
              19,
              17,
              16,
              16,
              17,
              19,
              28,
              20,
              22,
              20,
              22,
              20,
              28,
              43,
              27,
              31,
              27,
              27,
              31,
              27,
              43,
              38,
              46,
              37,
              35,
              37,
              46,
              38,
              68,
              53,
              47,
              47,
              53,
              68,
              78,
              66,
              62,
              66,
              78,
              95,
              85,
              85,
              95,
              119,
              113,
              119,
              156,
              156,
              209,
              255,
              194,
              0,
              17,
              8,
              1,
              144,
              1,
              144,
              3,
              1,
              34,
              0,
              2,
              17,
              1,
              3,
              17,
              1,
              255,
              196,
              0,
              51,
              0,
              1,
              0,
              3,
              1,
              1,
              1,
              1,
              1,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              6,
              7,
              8,
              5,
              4,
              3,
              2,
              1,
              1,
              1,
              1,
              1,
              1,
              1,
              1,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              1,
              5,
              4,
              3,
              6,
              255,
              218,
              0,
              12,
              3,
              1,
              0,
              2,
              16,
              3,
              16,
              0,
              0,
              0,
              191,
              192,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              140,
              146,
              96,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              2,
              143,
              188,
              51,
              37,
              154,
              111,
              50,
              233,
              172,
              202,
              105,
              161,
              40,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              60,
              199,
              165,
              4,
              230,
              165,
              154,
              172,
              251,
              132,
              193,
              243,
              250,
              40,
              0,
              0,
              204,
              154,
              111,
              50,
              89,
              166,
              243,
              46,
              154,
              204,
              166,
              154,
              18,
              128,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              161,
              83,
              187,
              91,
              205,
              174,
              122,
              166,
              164,
              223,
              184,
              217,
              216,
              139,
              245,
              38,
              101,
              21,
              116,
              203,
              162,
              4,
              248,
              74,
              0,
              12,
              201,
              166,
              243,
              37,
              154,
              111,
              50,
              233,
              172,
              202,
              105,
              161,
              40,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              87,
              48,
              142,
              6,
              139,
              179,
              249,
              156,
              250,
              214,
              105,
              15,
              153,
              78,
              69,
              127,
              0,
              191,
              198,
              125,
              208,
              92,
              126,
              193,
              249,
              127,
              99,
              156,
              190,
              189,
              79,
              156,
              89,
              133,
              171,
              56,
              250,
              66,
              229,
              154,
              249,
              254,
              156,
              201,
              166,
              243,
              38,
              135,
              46,
              155,
              204,
              186,
              107,
              50,
              154,
              104,
              74,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              3,
              197,
              237,
              228,
              153,
              239,
              70,
              209,
              183,
              37,
              153,
              251,
              78,
              80,
              55,
              240,
              18,
              128,
              7,
              198,
              19,
              53,
              133,
              96,
              106,
              134,
              14,
              179,
              189,
              193,
              239,
              104,
              240,
              247,
              179,
              38,
              155,
              204,
              159,
              91,
              131,
              166,
              243,
              46,
              154,
              204,
              166,
              154,
              18,
              128,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              241,
              123,
              70,
              101,
              209,
              153,
              195,
              70,
              217,
              157,
              52,
              222,
              118,
              180,
              73,
              192,
              148,
              3,
              203,
              28,
              37,
              145,
              217,
              11,
              155,
              210,
              11,
              252,
              151,
              254,
              49,
              53,
              35,
              114,
              207,
              223,
              211,
              87,
              131,
              245,
              153,
              52,
              222,
              100,
              208,
              229,
              211,
              121,
              151,
              77,
              102,
              83,
              77,
              9,
              64,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              2,
              184,
              134,
              223,
              57,
              254,
              203,
              183,
              57,
              78,
              237,
              194,
              159,
              176,
              99,
              144,
              242,
              216,
              136,
              196,
              229,
              5,
              109,
              117,
              200,
              121,
              132,
              148,
              74,
              0,
              12,
              201,
              166,
              243,
              37,
              154,
              111,
              46,
              106,
              58,
              152,
              235,
              163,
              130,
              70,
              142,
              9,
              31,
              98,
              9,
              223,
              44,
              97,
              40,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              249,
              253,
              5,
              61,
              92,
              234,
              126,
              125,
              149,
              124,
              151,
              195,
              196,
              37,
              17,
              159,
              228,
              144,
              168,
              110,
              153,
              111,
              220,
              9,
              64,
              1,
              150,
              181,
              45,
              118,
              159,
              128,
              0,
              0,
              22,
              59,
              201,
              235,
              80,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              255,
              196,
              0,
              78,
              16,
              0,
              1,
              3,
              1,
              5,
              3,
              5,
              10,
              10,
              5,
              11,
              5,
              0,
              0,
              0,
              0,
              1,
              2,
              3,
              4,
              5,
              0,
              6,
              7,
              17,
              18,
              33,
              49,
              146,
              16,
              19,
              65,
              81,
              210,
              20,
              48,
              55,
              64,
              71,
              97,
              117,
              134,
              179,
              196,
              23,
              34,
              80,
              85,
              100,
              113,
              114,
              148,
              178,
              227,
              22,
              32,
              50,
              82,
              129,
              21,
              35,
              36,
              51,
              54,
              66,
              68,
              83,
              144,
              145,
              209,
              98,
              115,
              116,
              147,
              162,
              255,
              218,
              0,
              8,
              1,
              1,
              0,
              1,
              63,
              0,
              255,
              0,
              80,
              215,
              111,
              133,
              222,
              102,
              164,
              138,
              113,
              153,
              174,
              89,
              144,
              134,
              57,
              166,
              208,
              163,
              146,
              214,
              66,
              118,
              171,
              246,
              118,
              124,
              160,
              253,
              245,
              188,
              15,
              95,
              6,
              105,
              201,
              144,
              134,
              162,
              166,
              170,
              136,
              197,
              8,
              64,
              26,
              208,
              30,
              211,
              180,
              156,
              207,
              39,
              148,
              47,
              88,
              61,
              227,
              229,
              4,
              248,
              65,
              30,
              159,
              30,
              223,
              147,
              202,
              23,
              172,
              30,
              241,
              242,
              130,
              124,
              32,
              143,
              79,
              143,
              111,
              201,
              229,
              11,
              214,
              15,
              120,
              249,
              10,
              76,
              168,
              209,
              25,
              83,
              210,
              100,
              52,
              203,
              99,
              122,
              220,
              88,
              66,
              70,
              103,
              45,
              164,
              218,
              118,
              34,
              93,
              120,
              154,
              130,
              36,
              185,
              33,
              97,
              101,
              37,
              44,
              32,
              159,
              227,
              154,
              180,
              130,
              44,
              113,
              90,
              239,
              116,
              66,
              159,
              194,
              223,
              106,
              195,
              22,
              46,
              238,
              204,
              225,
              79,
              224,
              71,
              110,
              208,
              175,
              213,
              214,
              154,
              80,
              148,
              212,
              144,
              210,
              202,
              51,
              33,
              240,
              90,
              28,
              74,
              201,
              54,
              66,
              208,
              180,
              37,
              104,
              80,
              82,
              84,
              1,
              10,
              4,
              16,
              65,
              218,
              8,
              239,
              41,
              240,
              130,
              61,
              62,
              61,
              191,
              39,
              148,
              47,
              88,
              61,
              227,
              228,
              27,
              207,
              137,
              77,
              71,
              46,
              68,
              162,
              228,
              235,
              160,
              148,
              174,
              74,
              182,
              160,
              127,
              219,
              180,
              122,
              109,
              232,
              189,
              146,
              92,
              144,
              150,
              223,
              150,
              173,
              161,
              79,
              56,
              66,
              80,
              141,
              185,
              233,
              5,
              89,
              1,
              191,
              48,
              129,
              104,
              88,
              75,
              36,
              128,
              103,
              85,
              91,
              65,
              215,
              181,
              12,
              160,
              172,
              113,
              43,
              77,
              149,
              132,
              151,
              117,
              35,
              108,
              234,
              135,
              27,
              125,
              139,
              63,
              133,
              20,
              34,
              218,
              195,
              19,
              231,
              37,
              204,
              190,
              42,
              150,
              80,
              177,
              194,
              18,
              45,
              80,
              194,
              138,
              171,
              40,
              43,
              129,
              57,
              153,
              89,
              39,
              106,
              22,
              57,
              149,
              231,
              212,
              55,
              139,
              70,
              168,
              94,
              107,
              167,
              48,
              178,
              20,
              252,
              85,
              3,
              169,
              76,
              56,
              51,
              105,
              205,
              185,
              103,
              150,
              227,
              187,
              45,
              66,
              215,
              74,
              253,
              68,
              175,
              30,
              228,
              144,
              216,
              143,
              56,
              12,
              194,
              55,
              165,
              222,
              178,
              142,
              207,
              120,
              79,
              132,
              17,
              233,
              241,
              237,
              249,
              60,
              161,
              122,
              193,
              239,
              31,
              32,
              95,
              203,
              234,
              103,
              58,
              229,
              50,
              153,
              35,
              250,
              26,
              118,
              60,
              234,
              55,
              60,
              123,
              22,
              186,
              88,
              114,
              167,
              180,
              77,
              173,
              182,
              67,
              69,
              57,
              162,
              54,
              208,
              79,
              157,
              203,
              101,
              30,
              36,
              108,
              135,
              54,
              203,
              13,
              55,
              230,
              66,
              27,
              66,
              71,
              240,
              0,
              11,
              85,
              49,
              42,
              239,
              194,
              91,
              141,
              176,
              93,
              152,
              224,
              11,
              0,
              181,
              177,
              189,
              67,
              173,
              106,
              178,
              177,
              116,
              255,
              0,
              114,
              134,
              145,
              245,
              201,
              61,
              155,
              51,
              139,
              141,
              235,
              108,
              61,
              68,
              33,
              25,
              128,
              178,
              135,
              255,
              0,
              220,
              128,
              81,
              106,
              61,
              249,
              187,
              117,
              101,
              33,
              166,
              229,
              152,
              239,
              168,
              228,
              27,
              146,
              57,
              178,
              126,
              165,
              109,
              77,
              167,
              83,
              224,
              84,
              99,
              170,
              52,
              216,
              141,
              188,
              209,
              207,
              226,
              175,
              172,
              140,
              179,
              29,
              68,
              103,
              176,
              139,
              93,
              203,
              137,
              18,
              131,
              85,
              147,
              53,
              18,
              11,
              233,
              45,
              132,
              48,
              22,
              6,
              166,
              243,
              223,
              159,
              120,
              79,
              132,
              17,
              233,
              241,
              237,
              249,
              60,
              161,
              122,
              193,
              239,
              30,
              63,
              136,
              215,
              140,
              211,
              41,
              98,
              3,
              11,
              202,
              76,
              208,
              83,
              246,
              25,
              220,
              174,
              43,
              97,
              213,
              213,
              77,
              69,
              243,
              85,
              154,
              133,
              119,
              60,
              117,
              142,
              101,
              61,
              14,
              57,
              255,
              0,
              8,
              181,
              82,
              167,
              22,
              147,
              1,
              249,
              210,
              201,
              230,
              90,
              25,
              156,
              182,
              146,
              78,
              192,
              7,
              156,
              218,
              187,
              121,
              171,
              87,
              166,
              83,
              108,
              6,
              215,
              205,
              107,
              60,
              204,
              70,
              65,
              86,
              125,
              179,
              106,
              70,
              20,
              184,
              166,
              210,
              237,
              98,
              97,
              104,
              145,
              253,
              67,
              27,
              84,
              62,
              181,
              155,
              53,
              135,
              151,
              77,
              8,
              66,
              21,
              79,
              83,
              132,
              36,
              2,
              181,
              60,
              230,
              106,
              180,
              188,
              53,
              186,
              207,
              160,
              33,
              166,
              30,
              142,
              115,
              207,
              91,
              78,
              147,
              237,
              53,
              218,
              187,
              134,
              53,
              88,
              33,
              111,
              83,
              156,
              238,
              214,
              70,
              103,
              70,
              90,
              94,
              2,
              215,
              42,
              244,
              215,
              33,
              84,
              226,
              209,
              220,
              109,
              201,
              12,
              184,
              250,
              26,
              45,
              47,
              61,
              108,
              116,
              29,
              61,
              65,
              60,
              134,
              217,
              139,
              59,
              80,
              138,
              217,
              201,
              78,
              140,
              199,
              64,
              219,
              186,
              200,
              171,
              69,
              59,
              202,
              147,
              252,
              63,
              226,
              200,
              90,
              22,
              1,
              66,
              194,
              135,
              88,
              60,
              169,
              240,
              130,
              61,
              62,
              61,
              191,
              39,
              148,
              47,
              88,
              61,
              227,
              199,
              239,
              100,
              201,
              21,
              235,
              217,
              41,
              182,
              70,
              179,
              207,
              136,
              113,
              145,
              172,
              16,
              66,
              14,
              129,
              196,
              109,
              74,
              167,
              177,
              76,
              167,
              68,
              130,
              192,
              248,
              140,
              160,
              35,
              61,
              218,
              143,
              74,
              190,
              178,
              109,
              136,
              183,
              133,
              202,
              141,
              89,
              116,
              246,
              150,
              68,
              88,
              106,
              211,
              144,
              59,
              22,
              240,
              216,
              162,
              69,
              174,
              61,
              214,
              110,
              135,
              78,
              75,
              239,
              180,
              59,
              190,
              64,
              5,
              213,
              116,
              182,
              131,
              185,
              175,
              213,
              85,
              14,
              150,
              107,
              13,
              214,
              4,
              112,
              38,
              37,
              149,
              54,
              87,
              215,
              171,
              164,
              249,
              192,
              216,
              15,
              45,
              74,
              114,
              138,
              148,
              194,
              14,
              64,
              108,
              81,
              235,
              243,
              114,
              199,
              146,
              228,
              119,
              2,
              146,
              126,
              177,
              208,
              108,
              203,
              200,
              121,
              180,
              184,
              147,
              177,
              92,
              137,
              240,
              130,
              61,
              62,
              61,
              191,
              39,
              148,
              47,
              88,
              61,
              227,
              199,
              170,
              18,
              251,
              138,
              157,
              58,
              102,
              130,
              177,
              29,
              135,
              29,
              41,
              221,
              152,
              66,
              117,
              101,
              108,
              63,
              136,
              36,
              222,
              202,
              110,
              182,
              181,
              161,
              162,
              183,
              143,
              152,
              182,
              130,
              82,
              120,
              173,
              80,
              149,
              220,
              84,
              233,
              211,
              10,
              53,
              8,
              241,
              220,
              116,
              142,
              176,
              129,
              171,
              43,
              92,
              168,
              43,
              171,
              222,
              184,
              101,
              253,
              110,
              132,
              56,
              169,
              79,
              44,
              156,
              201,
              45,
              252,
              108,
              215,
              159,
              90,
              178,
              7,
              188,
              60,
              176,
              219,
              78,
              47,
              247,
              82,
              77,
              137,
              42,
              36,
              147,
              153,
              59,
              207,
              47,
              72,
              181,
              25,
              100,
              165,
              228,
              244,
              2,
              15,
              34,
              124,
              32,
              143,
              79,
              143,
              111,
              201,
              229,
              11,
              214,
              15,
              120,
              241,
              235,
              198,
              7,
              232,
              221,
              123,
              209,
              239,
              254,
              3,
              108,
              39,
              203,
              244,
              146,
              79,
              254,
              3,
              159,
              141,
              22,
              188,
              164,
              139,
              187,
              91,
              200,
              127,
              128,
              145,
              248,
              13,
              176,
              159,
              251,
              69,
              47,
              209,
              206,
              254,
              52,
              119,
              135,
              155,
              14,
              52,
              226,
              51,
              203,
              82,
              72,
              177,
              5,
              36,
              130,
              50,
              35,
              120,
              229,
              233,
              22,
              163,
              36,
              132,
              190,
              174,
              130,
              64,
              228,
              79,
              132,
              17,
              233,
              241,
              237,
              249,
              60,
              161,
              122,
              193,
              239,
              30,
              61,
              80,
              137,
              221,
              180,
              233,
              208,
              245,
              148,
              9,
              12,
              56,
              214,
              173,
              250,
              117,
              167,
              78,
              118,
              195,
              249,
              98,
              45,
              236,
              166,
              149,
              187,
              161,
              14,
              235,
              104,
              249,
              245,
              160,
              132,
              142,
              43,
              84,
              98,
              25,
              212,
              233,
              208,
              245,
              232,
              50,
              35,
              58,
              200,
              81,
              25,
              233,
              214,
              146,
              156,
              237,
              113,
              39,
              170,
              155,
              122,
              160,
              235,
              42,
              66,
              94,
              81,
              140,
              224,
              203,
              165,
              221,
              128,
              31,
              169,
              93,
              230,
              165,
              5,
              65,
              74,
              121,
              3,
              102,
              245,
              36,
              116,
              121,
              249,
              99,
              70,
              114,
              67,
              129,
              41,
              27,
              178,
              204,
              245,
              89,
              150,
              80,
              203,
              105,
              109,
              59,
              135,
              34,
              124,
              32,
              143,
              79,
              143,
              111,
              201,
              229,
              11,
              214,
              15,
              120,
              241,
              251,
              217,
              10,
              69,
              6,
              246,
              202,
              91,
              39,
              65,
              18,
              4,
              184,
              235,
              208,
              0,
              26,
              206,
              177,
              194,
              109,
              76,
              168,
              49,
              83,
              167,
              67,
              156,
              193,
              26,
              30,
              108,
              47,
              126,
              101,
              36,
              239,
              73,
              243,
              131,
              108,
              70,
              187,
              206,
              211,
              43,
              46,
              78,
              105,
              181,
              119,
              36,
              211,
              175,
              87,
              66,
              93,
              222,
              180,
              218,
              227,
              222,
              164,
              87,
              96,
              6,
              164,
              60,
              158,
              239,
              97,
              57,
              58,
              157,
              197,
              105,
              232,
              112,
              126,
              172,
              185,
              81,
              161,
              199,
              114,
              68,
              151,
              144,
              211,
              45,
              128,
              84,
              181,
              157,
              32,
              90,
              239,
              94,
              150,
              47,
              4,
              218,
              186,
              34,
              163,
              40,
              177,
              121,
              144,
              211,
              135,
              61,
              110,
              149,
              235,
              212,
              171,
              27,
              100,
              44,
              228,
              8,
              142,
              29,
              69,
              161,
              159,
              88,
              204,
              111,
              176,
              166,
              66,
              255,
              0,
              43,
              255,
              0,
              163,
              100,
              33,
              8,
              25,
              33,
              33,
              35,
              168,
              14,
              84,
              248,
              65,
              30,
              159,
              30,
              223,
              147,
              202,
              23,
              172,
              30,
              241,
              227,
              248,
              139,
              119,
              13,
              82,
              148,
              42,
              17,
              208,
              59,
              166,
              16,
              82,
              142,
              225,
              173,
              157,
              234,
              225,
              222,
              45,
              135,
              23,
              164,
              65,
              145,
              252,
              143,
              49,
              106,
              230,
              36,
              44,
              115,
              10,
              232,
              105,
              195,
              219,
              181,
              90,
              149,
              6,
              175,
              5,
              232,
              83,
              27,
              43,
              105,
              99,
              97,
              7,
              37,
              33,
              93,
              10,
              73,
              235,
              22,
              173,
              221,
              218,
              229,
              212,
              156,
              151,
              130,
              220,
              75,
              97,
              194,
              24,
              150,
              209,
              211,
              159,
              100,
              218,
              137,
              138,
              170,
              66,
              18,
              213,
              102,
              41,
              89,
              0,
              100,
              251,
              0,
              109,
              251,
              104,
              54,
              137,
              125,
              46,
              180,
              205,
              97,
              186,
              195,
              9,
              211,
              191,
              157,
              205,
              159,
              105,
              166,
              210,
              111,
              101,
              219,
              140,
              201,
              113,
              202,
              196,
              66,
              145,
              208,
              219,
              161,
              213,
              112,
              163,
              51,
              106,
              174,
              40,
              209,
              227,
              130,
              152,
              12,
              59,
              45,
              125,
              100,
              115,
              77,
              218,
              85,
              70,
              243,
              223,
              41,
              193,
              132,
              133,
              188,
              127,
              104,
              48,
              215,
              196,
              105,
              25,
              90,
              231,
              93,
              65,
              119,
              35,
              62,
              23,
              36,
              187,
              34,
              71,
              54,
              93,
              253,
              192,
              81,
              208,
              142,
              46,
              240,
              159,
              8,
              35,
              211,
              227,
              219,
              242,
              76,
              148,
              212,
              59,
              239,
              38,
              83,
              185,
              243,
              108,
              214,
              150,
              234,
              242,
              234,
              67,
              217,
              155,
              12,
              78,
              186,
              255,
              0,
              75,
              224,
              176,
              196,
              235,
              175,
              244,
              190,
              11,
              12,
              78,
              186,
              255,
              0,
              75,
              224,
              183,
              194,
              117,
              215,
              250,
              95,
              5,
              134,
              39,
              93,
              127,
              165,
              127,
              235,
              181,
              14,
              247,
              81,
              235,
              210,
              29,
              143,
              9,
              78,
              115,
              136,
              111,
              89,
              11,
              70,
              89,
              164,
              28,
              188,
              106,
              255,
              0,
              220,
              245,
              211,
              36,
              174,
              167,
              1,
              140,
              160,
              60,
              115,
              90,
              80,
              54,
              48,
              190,
              193,
              181,
              207,
              196,
              100,
              229,
              30,
              159,
              91,
              63,
              244,
              34,
              97,
              62,
              215,
              183,
              98,
              35,
              76,
              143,
              180,
              54,
              244,
              119,
              145,
              230,
              90,
              22,
              133,
              127,
              184,
              32,
              218,
              175,
              133,
              244,
              89,
              100,
              185,
              1,
              231,
              33,
              44,
              171,
              106,
              114,
              231,
              91,
              179,
              216,
              79,
              92,
              75,
              139,
              230,
              167,
              65,
              91,
              125,
              5,
              69,
              105,
              54,
              24,
              79,
              95,
              212,
              157,
              115,
              96,
              4,
              231,
              180,
              133,
              185,
              216,
              181,
              59,
              10,
              169,
              108,
              57,
              174,
              124,
              215,
              165,
              109,
              4,
              33,
              41,
              12,
              162,
              209,
              97,
              211,
              104,
              240,
              138,
              35,
              180,
              204,
              88,
              205,
              141,
              74,
              59,
              16,
              54,
              12,
              181,
              44,
              253,
              67,
              105,
              54,
              161,
              222,
              120,
              21,
              217,
              53,
              6,
              224,
              234,
              91,
              81,
              67,
              95,
              206,
              157,
              129,
              101,
              205,
              91,
              129,
              200,
              228,
              52,
              247,
              132,
              248,
              65,
              30,
              159,
              30,
              223,
              146,
              167,
              133,
              226,
              125,
              70,
              124,
              211,
              90,
              209,
              221,
              18,
              93,
              123,
              71,
              115,
              231,
              150,
              181,
              21,
              111,
              215,
              111,
              130,
              20,
              252,
              252,
              126,
              235,
              249,
              150,
              248,
              33,
              79,
              207,
              199,
              238,
              191,
              153,
              111,
              130,
              20,
              252,
              252,
              126,
              235,
              249,
              150,
              248,
              33,
              31,
              63,
              31,
              186,
              254,
              101,
              134,
              17,
              117,
              215,
              79,
              221,
              127,
              50,
              215,
              106,
              225,
              185,
              119,
              170,
              137,
              154,
              138,
              184,
              120,
              22,
              214,
              210,
              219,
              238,
              125,
              58,
              146,
              122,
              142,
              179,
              227,
              75,
              66,
              28,
              65,
              74,
              128,
              82,
              84,
              8,
              32,
              129,
              145,
              7,
              97,
              7,
              59,
              94,
              156,
              52,
              231,
              150,
              244,
              218,
              30,
              73,
              42,
              57,
              152,
              135,
              226,
              167,
              206,
              91,
              54,
              167,
              87,
              239,
              29,
              218,
              125,
              81,
              208,
              227,
              172,
              233,
              80,
              43,
              138,
              250,
              54,
              112,
              171,
              118,
              118,
              167,
              98,
              211,
              25,
              1,
              80,
              166,
              56,
              149,
              4,
              109,
              91,
              10,
              10,
              205,
              95,
              97,
              118,
              143,
              137,
              23,
              81,
              230,
              66,
              215,
              45,
              214,
              21,
              210,
              135,
              26,
              89,
              35,
              128,
              42,
              210,
              49,
              34,
              234,
              50,
              222,
              182,
              229,
              186,
              249,
              253,
              198,
              218,
              88,
              39,
              140,
              38,
              213,
              44,
              88,
              100,
              2,
              154,
              101,
              49,
              68,
              148,
              108,
              114,
              74,
              178,
              200,
              253,
              132,
              89,
              217,
              55,
              178,
              249,
              75,
              45,
              128,
              244,
              128,
              21,
              159,
              54,
              143,
              136,
              195,
              91,
              200,
              207,
              160,
              117,
              2,
              109,
              115,
              174,
              153,
              187,
              81,
              228,
              235,
              146,
              94,
              126,
              78,
              130,
              238,
              145,
              146,
              19,
              160,
              110,
              79,
              120,
              153,
              41,
              184,
              87,
              210,
              84,
              183,
              66,
              138,
              24,
              172,
              173,
              213,
              132,
              239,
              33,
              15,
              106,
              57,
              89,
              56,
              183,
              119,
              82,
              54,
              65,
              168,
              112,
              55,
              219,
              178,
              113,
              110,
              238,
              164,
              108,
              131,
              80,
              224,
              111,
              183,
              100,
              226,
              221,
              221,
              72,
              217,
              6,
              161,
              192,
              223,
              110,
              201,
              197,
              187,
              186,
              145,
              178,
              13,
              67,
              129,
              190,
              221,
              147,
              139,
              119,
              117,
              35,
              100,
              26,
              135,
              3,
              125,
              187,
              39,
              22,
              238,
              234,
              70,
              200,
              53,
              14,
              6,
              251,
              118,
              78,
              45,
              221,
              212,
              141,
              144,
              106,
              28,
              13,
              246,
              236,
              156,
              91,
              187,
              169,
              27,
              32,
              212,
              56,
              27,
              237,
              248,
              229,
              66,
              153,
              79,
              169,
              51,
              204,
              206,
              134,
              211,
              233,
              200,
              229,
              172,
              103,
              167,
              80,
              200,
              233,
              61,
              7,
              206,
              45,
              55,
              11,
              174,
              235,
              229,
              102,
              59,
              178,
              163,
              18,
              157,
              137,
              74,
              181,
              161,
              60,
              118,
              248,
              33,
              79,
              207,
              199,
              238,
              191,
              153,
              100,
              225,
              19,
              105,
              90,
              121,
              202,
              225,
              35,
              49,
              152,
              76,
              124,
              143,
              227,
              181,
              63,
              13,
              238,
              212,
              39,
              117,
              184,
              211,
              178,
              136,
              82,
              74,
              67,
              235,
              204,
              12,
              188,
              200,
              9,
              6,
              204,
              70,
              98,
              51,
              105,
              102,
              59,
              40,
              105,
              164,
              231,
              165,
              8,
              72,
              74,
              70,
              125,
              64,
              100,
              7,
              120,
              6,
              211,
              112,
              210,
              131,
              50,
              92,
              169,
              110,
              74,
              156,
              22,
              251,
              171,
              117,
              64,
              45,
              188,
              129,
              89,
              207,
              102,
              105,
              178,
              176,
              146,
              238,
              164,
              109,
              157,
              80,
              227,
              111,
              177,
              101,
              97,
              37,
              221,
              72,
              219,
              58,
              161,
              198,
              223,
              98,
              202,
              194,
              75,
              186,
              145,
              182,
              117,
              67,
              141,
              190,
              197,
              149,
              132,
              151,
              117,
              35,
              108,
              234,
              135,
              27,
              125,
              139,
              43,
              9,
              46,
              234,
              70,
              217,
              213,
              14,
              54,
              251,
              22,
              86,
              18,
              93,
              212,
              141,
              179,
              170,
              28,
              109,
              246,
              44,
              172,
              36,
              187,
              169,
              27,
              103,
              84,
              56,
              219,
              236,
              89,
              88,
              73,
              119,
              82,
              54,
              206,
              168,
              113,
              183,
              216,
              180,
              56,
              201,
              137,
              18,
              52,
              100,
              45,
              106,
              67,
              13,
              33,
              180,
              169,
              123,
              84,
              66,
              6,
              67,
              60,
              128,
              218,
              127,
              214,
              67,
              255,
              196,
              0,
              39,
              17,
              0,
              1,
              3,
              2,
              6,
              1,
              4,
              3,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              1,
              0,
              2,
              33,
              4,
              17,
              3,
              5,
              32,
              49,
              64,
              81,
              16,
              18,
              20,
              112,
              129,
              48,
              97,
              145,
              255,
              218,
              0,
              8,
              1,
              2,
              1,
              1,
              63,
              0,
              249,
              88,
              33,
              194,
              177,
              86,
              58,
              66,
              28,
              24,
              82,
              165,
              70,
              128,
              135,
              3,
              97,
              226,
              229,
              92,
              248,
              169,
              168,
              101,
              62,
              25,
              123,
              190,
              135,
              101,
              59,
              56,
              199,
              46,
              184,
              99,
              64,
              233,
              81,
              214,
              178,
              169,
              166,
              44,
              241,
              184,
              65,
              14,
              1,
              221,
              29,
              25,
              215,
              170,
              248,
              93,
              79,
              247,
              198,
              85,
              234,
              247,
              108,
              183,
              238,
              232,
              33,
              192,
              61,
              163,
              51,
              162,
              166,
              157,
              149,
              24,
              101,
              142,
              250,
              61,
              20,
              114,
              108,
              123,
              198,
              35,
              108,
              168,
              232,
              153,
              74,
              210,
              111,
              119,
              157,
              202,
              8,
              112,
              4,
              194,
              144,
              161,
              70,
              144,
              129,
              80,
              161,
              71,
              230,
              186,
              133,
              26,
              161,
              66,
              133,
              31,
              52,
              127,
              255,
              196,
              0,
              40,
              17,
              0,
              1,
              2,
              4,
              4,
              5,
              5,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              1,
              0,
              33,
              2,
              3,
              17,
              32,
              4,
              16,
              18,
              64,
              5,
              49,
              65,
              112,
              241,
              20,
              35,
              48,
              81,
              97,
              255,
              218,
              0,
              8,
              1,
              3,
              1,
              1,
              63,
              0,
              238,
              185,
              217,
              84,
              42,
              139,
              78,
              196,
              156,
              153,
              50,
              123,
              14,
              199,
              174,
              84,
              10,
              131,
              41,
              50,
              162,
              155,
              30,
              152,
              124,
              33,
              195,
              165,
              233,
              120,
              162,
              170,
              196,
              97,
              162,
              144,
              67,
              212,
              30,
              168,
              236,
              71,
              36,
              57,
              89,
              195,
              116,
              251,
              159,
              109,
              150,
              58,
              158,
              156,
              215,
              241,
              29,
              136,
              65,
              154,
              201,
              51,
              98,
              149,
              30,
              168,
              124,
              161,
              196,
              165,
              209,
              224,
              138,
              171,
              17,
              137,
              138,
              121,
              229,
              72,
              71,
              68,
              118,
              76,
              157,
              61,
              167,
              39,
              78,
              133,
              126,
              119,
              79,
              105,
              9,
              211,
              167,
              79,
              222,
              143,
              255,
              217,
            ],
            "type": "Buffer",
          },
        },
        "interests": "blockchain, NFTs",
        "name": "Delegatee name",
        "signature": "0x52a3c23ef6c6817691872b77615ef30927453d641acd8c607de458d39e581bcd5411f723102640897af151644086abf4f3a9baf216d684d784194aef2c6730be1c",
        "twitterUrl": "https://example.com/x",
        "verificationUrl": "https://example.com/verification",
        "websiteUrl": "https://example.com",
      },
    ]
  `);
});

it('handles validation errors', async () => {
  const createDelegationPRMock = vi.spyOn(utils, 'createDelegationPR');
  const isAddressAnAccountMock = vi.spyOn(utils, 'isAddressAnAccount');

  isAddressAnAccountMock.mockResolvedValueOnce(false);

  const response = await POST(getRequest(await getValidFormData()));

  expect(response.status).toBe(400);

  const body = await response.json();

  expect(body).toMatchInlineSnapshot(`
    {
      "errors": {
        "address": "Address is not an account",
      },
      "message": "Invalid delegatee registration request",
      "status": "error",
    }
  `);
  expect(isAddressAnAccountMock).toHaveBeenCalledTimes(1);
  expect(createDelegationPRMock).not.toHaveBeenCalled();
});

it('handles PR creation error', async () => {
  const createDelegationPRMock = vi.spyOn(utils, 'createDelegationPR');
  const isAddressAnAccountMock = vi.spyOn(utils, 'isAddressAnAccount');

  createDelegationPRMock.mockRejectedValueOnce(new Error('Mock PR creation error'));

  isAddressAnAccountMock.mockResolvedValueOnce(true);

  const response = await POST(getRequest(await getValidFormData()));

  expect(response.status).toBe(500);

  const body = await response.json();

  expect(body).toMatchInlineSnapshot(`
    {
      "message": "Error creating PR",
      "status": "error",
    }
  `);
  expect(isAddressAnAccountMock).toHaveBeenCalledTimes(1);
  expect(createDelegationPRMock).toHaveBeenCalledTimes(1);
});

it('handles generic error', async () => {
  const createDelegationPRMock = vi.spyOn(utils, 'createDelegationPR');
  const isAddressAnAccountMock = vi.spyOn(utils, 'isAddressAnAccount');

  isAddressAnAccountMock.mockResolvedValueOnce(true);

  const response = await POST({
    formData: () => {
      throw new Error('Mock error');
    },
  } as any as Request);

  expect(response.status).toBe(400);

  const body = await response.json();

  expect(body).toMatchInlineSnapshot(`
    {
      "message": "Error parsing request",
      "status": "error",
    }
  `);
  expect(isAddressAnAccountMock).not.toHaveBeenCalled();
  expect(createDelegationPRMock).not.toHaveBeenCalled();
});
